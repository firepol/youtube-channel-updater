# PRD 3.2: Video Processing Engine

## Overview
Implement the core video processing logic that transforms video metadata according to configured rules.

## Requirements

### Core Deliverables
- [ ] `scripts/process-videos.ts` - Main script
- [ ] Title/description transformation
- [ ] Tag management (base + dynamic)
- [ ] Metadata versioning
- [ ] Video settings updates
- [ ] Backup system integration
- [ ] Error handling and retry logic

### Dependencies
- PRD 3.1 (Video Filtering System)
- PRD 2.1 (Video Database Builder)
- PRD 1.2 (YouTube API Integration)

### Technical Specifications

#### Script Interface
```bash
# Process filtered videos
ts-node scripts/process-videos.ts --input filtered-videos.json

# Process specific video
ts-node scripts/process-videos.ts --video-id video_id_1

# Dry run (no API calls)
ts-node scripts/process-videos.ts --dry-run --input filtered-videos.json

# Force processing (ignore metadata version)
ts-node scripts/process-videos.ts --force --input filtered-videos.json

# Verbose logging
ts-node scripts/process-videos.ts --verbose --input filtered-videos.json
```

#### Title Transformation
```typescript
interface TitleTransformer {
  // Input: "Tom Clancy's The Division 2 2025 03 29   10 01 17 02 going rogue gone wrong"
  // Output: "DZ going rogue gone wrong / The Division 2 / 2025-03-29"
  transformTitle(originalTitle: string, recordingDate: string): string;
  
  // Extract content part from title
  extractContent(title: string): string;
  
  // Format date according to template
  formatDate(date: string): string;
}
```

#### Description Transformation
```typescript
interface DescriptionTransformer {
  // Input: "Tom Clancy's The Division 2 2025 03 29   10 01 17 02"
  // Output: "Tom Clancy's The Division 2 / 2025-03-29 10:01 [metadata v1.1: 2025-06-27 10:01:32]"
  transformDescription(originalDesc: string, recordingDate: string, metadataVersion: string): string;
  
  // Add metadata version tag
  addMetadataTag(description: string, version: string): string;
}
```

#### Tag Management
```typescript
interface TagManager {
  // Base tags for all videos
  baseTags: string[];
  
  // Extract dynamic tags from title
  extractDynamicTags(title: string, count: number): string[];
  
  // Map keywords to specific tags
  mapKeywords(title: string): string[];
  
  // Combine and deduplicate tags
  generateFinalTags(baseTags: string[], dynamicTags: string[]): string[];
}
```

#### Video Settings Updates
```typescript
interface VideoSettings {
  audience: 'notMadeForKids';
  license: 'creativeCommon';
  categoryId: '20'; // Gaming
  recordingDate: string;
  tags: string[];
  title: string;
  description: string;
  shortsRemixing: 'allow';
}
```

#### Backup System Integration
```typescript
interface BackupManager {
  // Backup before processing
  backupVideo(videoId: string, currentData: VideoData): Promise<void>;
  
  // Update history
  updateHistory(videoId: string, field: string, oldValue: string, newValue: string): Promise<void>;
  
  // Check if backup exists
  hasBackup(videoId: string): boolean;
}
```

#### Error Handling & Retry Logic
- **Retry Strategy**: 3 attempts with exponential backoff
- **Error Types**:
  - Rate limit errors: Stop immediately
  - Network errors: Retry with backoff
  - API errors: Log and continue
  - Validation errors: Skip video
- **Recovery**: Can resume from last successful video

#### Processing Flow
1. **Load Video Data**: From filtered input or database
2. **Backup Current State**: Save to history
3. **Transform Title**: Apply title transformation rules
4. **Transform Description**: Apply description transformation rules
5. **Generate Tags**: Base tags + dynamic tags
6. **Update Video**: Call YouTube API
7. **Update History**: Record changes
8. **Update Database**: Refresh local database

#### Output Format
```json
{
  "processedVideos": 45,
  "successfulUpdates": 43,
  "failedUpdates": 2,
  "errors": [
    {
      "videoId": "video_id_1",
      "error": "Rate limit exceeded",
      "attempts": 3
    }
  ],
  "processingTime": "00:05:30"
}
```

## Acceptance Criteria
- [ ] Correctly transforms titles and descriptions
- [ ] Generates appropriate tags (base + dynamic)
- [ ] Updates video metadata via YouTube API
- [ ] Creates proper backups before changes
- [ ] Handles errors gracefully with retry logic
- [ ] Respects rate limits
- [ ] Updates local database after successful changes
- [ ] Provides clear progress reporting

## Edge Cases
- Handle videos with missing recording dates
- Deal with transformation failures
- Handle API quota exhaustion
- Manage very long titles/descriptions
- Handle videos with existing metadata tags
- Deal with network timeouts

## Dependencies
- PRD 3.1 (Video Filtering System)
- PRD 2.1 (Video Database Builder)
- PRD 1.2 (YouTube API Integration)

## Estimated Time
4 hours

## Notes
This is the core processing engine. Focus on reliability and proper error handling. The backup system is critical for data safety.
