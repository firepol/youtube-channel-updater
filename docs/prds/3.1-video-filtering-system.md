# PRD 3.1: Video Filtering System

## Overview
Implement a flexible video filtering system that can identify videos based on various criteria for processing.

## Requirements

### Core Deliverables
- [ ] `scripts/filter-videos.ts` - Main script
- [ ] Comprehensive filter types covering all major YouTube API fields
- [ ] Support for metadata version checking
- [ ] Configurable filter rules
- [ ] Preview mode (show count without processing)

### Dependencies
- PRD 2.1 (Video Database Builder)
- PRD 1.3 (Configuration System)

### Technical Specifications

#### Script Interface
```bash
# Basic text filters
ts-node scripts/filter-videos.ts --title-contains "Tom Clancy"
ts-node scripts/filter-videos.ts --description-not-contains "[metadata"

# Visibility/Privacy filters
ts-node scripts/filter-videos.ts --privacy-status "private"
ts-node scripts/filter-videos.ts --upload-status "uploaded"
ts-node scripts/filter-videos.ts --processing-status "succeeded"

# Date filters
ts-node scripts/filter-videos.ts --published-after "2025-01-01"
ts-node scripts/filter-videos.ts --published-before "2025-01-31"
ts-node scripts/filter-videos.ts --recording-date-after "2025-01-01"

# Statistics filters
ts-node scripts/filter-videos.ts --min-views 1000
ts-node scripts/filter-videos.ts --max-views 10000
ts-node scripts/filter-videos.ts --min-likes 50

# Content filters
ts-node scripts/filter-videos.ts --category-id "20"
ts-node scripts/filter-videos.ts --made-for-kids false
ts-node scripts/filter-videos.ts --license "creativeCommon"

# Multiple filters
ts-node scripts/filter-videos.ts --privacy-status "private" --title-contains "Tom Clancy"

# Preview mode (count only)
ts-node scripts/filter-videos.ts --preview --privacy-status "private"

# Use configuration file
ts-node scripts/filter-videos.ts --config config/initial-processing.json

# Verbose output
ts-node scripts/filter-videos.ts --verbose --privacy-status "private"
```

#### Filter Types
```typescript
interface FilterRule {
  type: 
    // Text-based filters
    | 'title_contains' | 'title_not_contains' 
    | 'description_contains' | 'description_not_contains'
    | 'tags_contains' | 'tags_not_contains'
    
    // Status filters
    | 'privacy_status' | 'upload_status' | 'processing_status'
    | 'made_for_kids' | 'embeddable' | 'public_stats_viewable'
    
    // Date filters
    | 'published_after' | 'published_before'
    | 'recording_date_after' | 'recording_date_before'
    | 'last_processed_after' | 'last_processed_before'
    
    // Statistics filters
    | 'min_views' | 'max_views'
    | 'min_likes' | 'max_likes'
    | 'min_comments' | 'max_comments'
    
    // Content filters
    | 'category_id' | 'license' | 'definition'
    | 'caption' | 'default_language' | 'default_audio_language'
    
    // Metadata filters
    | 'metadata_version' | 'has_metadata_version'
    | 'has_recording_date' | 'has_tags'
    
    // Processing filters
    | 'needs_processing' | 'already_processed'
    | 'processing_failed' | 'has_processing_errors';
    
  value: string | number | boolean;
  caseSensitive?: boolean; // For text filters only
}

interface FilterResult {
  videoId: string;
  title: string;
  description: string;
  matchedRules: string[];
  recordingDate?: string;
  privacyStatus: string;
  uploadStatus: string;
  processingStatus?: string;
  statistics?: {
    viewCount: string;
    likeCount: string;
    commentCount: string;
  };
}
```

#### Configuration Format
```json
{
  "initialProcessing": {
    "enabled": true,
    "filters": [
      {
        "type": "privacy_status",
        "value": "private"
      },
      {
        "type": "upload_status",
        "value": "uploaded"
      },
      {
        "type": "processing_status",
        "value": "succeeded"
      },
      {
        "type": "title_contains",
        "value": "Tom Clancy",
        "caseSensitive": false
      },
      {
        "type": "description_not_contains",
        "value": "[metadata",
        "caseSensitive": false
      },
      {
        "type": "made_for_kids",
        "value": false
      },
      {
        "type": "min_views",
        "value": 0
      },
      {
        "type": "published_after",
        "value": "2025-01-01"
      }
    ]
  },
  "draftProcessing": {
    "enabled": true,
    "filters": [
      {
        "type": "upload_status",
        "value": "uploaded"
      },
      {
        "type": "privacy_status",
        "value": "private"
      },
      {
        "type": "processing_status",
        "value": "succeeded"
      }
    ]
  },
  "failedProcessing": {
    "enabled": true,
    "filters": [
      {
        "type": "processing_status",
        "value": "failed"
      }
    ]
  },
  "popularVideos": {
    "enabled": true,
    "filters": [
      {
        "type": "min_views",
        "value": 1000
      },
      {
        "type": "privacy_status",
        "value": "public"
      }
    ]
  }
}
```

#### Available YouTube API Filter Fields

##### Status Filters
- **`privacy_status`**: `"private" | "public" | "unlisted"`
- **`upload_status`**: `"uploaded" | "processing" | "failed" | "rejected"`
- **`processing_status`**: `"succeeded" | "processing" | "failed"`
- **`made_for_kids`**: `true | false`
- **`embeddable`**: `true | false`
- **`public_stats_viewable`**: `true | false`

##### Date Filters
- **`published_after`**: ISO date string (e.g., "2025-01-01")
- **`published_before`**: ISO date string
- **`recording_date_after`**: ISO date string
- **`recording_date_before`**: ISO date string
- **`last_processed_after`**: ISO date string (from local metadata)
- **`last_processed_before`**: ISO date string

##### Statistics Filters
- **`min_views`**: Minimum view count
- **`max_views`**: Maximum view count
- **`min_likes`**: Minimum like count
- **`max_likes`**: Maximum like count
- **`min_comments`**: Minimum comment count
- **`max_comments`**: Maximum comment count

##### Content Filters
- **`category_id`**: YouTube category ID (e.g., "20" for Gaming)
- **`license`**: `"youtube" | "creativeCommon"`
- **`definition`**: `"hd" | "sd"`
- **`caption`**: `"true" | "false"`
- **`default_language`**: Language code (e.g., "en")
- **`default_audio_language`**: Language code

##### Text Filters
- **`title_contains`**: Substring in title
- **`title_not_contains`**: Substring not in title
- **`description_contains`**: Substring in description
- **`description_not_contains`**: Substring not in description
- **`tags_contains`**: Tag contains substring
- **`tags_not_contains`**: Tag doesn't contain substring

##### Metadata Filters
- **`metadata_version`**: Check for specific metadata version
- **`has_metadata_version`**: `true | false` (has any metadata version)
- **`has_recording_date`**: `true | false`
- **`has_tags`**: `true | false`

##### Processing Filters
- **`needs_processing`**: `true | false` (based on metadata version)
- **`already_processed`**: `true | false` (has current metadata version)
- **`processing_failed`**: `true | false` (has processing errors)
- **`has_processing_errors`**: `true | false`

#### Filtering Logic
- **Case Sensitivity**: Default to case-insensitive for text filters
- **Multiple Filters**: AND logic (all filters must match)
- **Date Comparisons**: Use ISO date string comparisons
- **Number Comparisons**: Use numeric comparisons for statistics
- **Boolean Filters**: Exact match for boolean values
- **Array Filters**: Check if any element matches (for tags)
- **Performance**: Use efficient string operations and indexing

#### Output Formats

##### Preview Mode
```
Found 45 videos matching criteria:
- privacy_status: "private"
- upload_status: "uploaded"
- processing_status: "succeeded"
- title_contains: "Tom Clancy"
- description_not_contains: "[metadata"

Videos to be processed:
1. video_id_1: "Tom Clancy's The Division 2 2025 03 29..." (private, 0 views)
2. video_id_2: "Tom Clancy's The Division 2 2025 03 30..." (private, 0 views)
...
```

##### Full Mode
```json
{
  "filterCriteria": [
    {"type": "privacy_status", "value": "private"},
    {"type": "upload_status", "value": "uploaded"},
    {"type": "title_contains", "value": "Tom Clancy"},
    {"type": "description_not_contains", "value": "[metadata"}
  ],
  "totalVideos": 45,
  "videos": [
    {
      "videoId": "video_id_1",
      "title": "Tom Clancy's The Division 2 2025 03 29...",
      "description": "Tom Clancy's The Division 2 2025 03 29...",
      "matchedRules": ["privacy_status", "upload_status", "title_contains", "description_not_contains"],
      "recordingDate": "2025-03-29T10:01:17Z",
      "privacyStatus": "private",
      "uploadStatus": "uploaded",
      "processingStatus": "succeeded",
      "statistics": {
        "viewCount": "0",
        "likeCount": "0",
        "commentCount": "0"
      }
    }
  ]
}
```

#### Performance Considerations
- **Large Databases**: Efficient filtering algorithms with early termination
- **Memory Usage**: Stream processing for large datasets
- **Caching**: Cache filter results for repeated queries
- **Indexing**: Use video database structure for fast lookups
- **Date Indexing**: Index by published date for date range queries

## Acceptance Criteria
- [ ] Correctly filters videos based on all filter types
- [ ] Handles case sensitivity properly for text filters
- [ ] Supports multiple filter combinations with AND logic
- [ ] Preview mode shows accurate counts and sample data
- [ ] Configuration file loading works correctly
- [ ] Performance is acceptable for large video databases
- [ ] Clear, readable output in both modes
- [ ] Proper handling of missing/undefined values
- [ ] Date filtering works with various date formats

## Edge Cases
- Handle videos with missing titles, descriptions, or metadata
- Deal with very long titles/descriptions
- Handle special characters in filter values
- Manage empty filter results
- Handle malformed metadata version tags
- Handle videos with missing statistics
- Handle videos with processing errors
- Handle videos with missing upload/processing status

## Dependencies
- PRD 2.1 (Video Database Builder)
- PRD 1.3 (Configuration System)

## Estimated Time
3 hours (increased due to comprehensive filter types)

## Notes
This comprehensive filtering system provides the foundation for identifying which videos need processing based on any combination of YouTube API fields. The filtering logic should be flexible, efficient, and handle all edge cases gracefully.
